---
import Layout from "../components/Layout.astro";
import { db } from "@wolf-project/db";
import AllProjects from "../components/DisplayAllProjects";

const t = Astro.locals.t;
const projects = await db.query.projectsTable.findMany({
  with: { tasks: true, users: {with: {user:true}} },
});
---

<Layout title={undefined} description={undefined}>
  <AllProjects
    projects={projects.map((project) => ({
      ...project,
      deadline: project.tasks.toSorted((a, b)=>a.deadline.getTime()-b.deadline.getTime())[0]?.deadline.toDateString()!,
      manager: project.users.find(u=>u.priviledgeLevel==="manager")?.user.name || "",
      progress: `${project.tasks.filter(t=>t.completed).length}/${project.tasks.length}`,
      status: project.tasks.every(t=>t.completed) ? t.status.completed : t.status.inprogress,
    }))}
    t={t.allProjects}
    client:load
  />
</Layout>
