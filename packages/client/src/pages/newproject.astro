---
import { db, Users, eq, or } from "astro:db";
import Layout from "../components/Layout.astro";
import { NewProject } from "../components/NewProject/NewProject";
import { Employee } from "../components/NewProject/NewProject";

const user = Astro.locals.user;
if (!user) return Astro.redirect("/401");

if (user.role !== "admin" && user.role !== "limited") return Astro.redirect("/401");
let mandatoryUser: Employee | undefined;
if (user.role === "limited") {
  mandatoryUser = { value: user.userId, label: user.name };
}
const employees = await db
  .select({ value: Users.userId, label: Users.name })
  .from(Users)
  .where(or(eq(Users.role, "admin"), eq(Users.role, "limited")));
---

<Layout title={undefined} description={undefined}>
  <NewProject
    mandatoryMember={mandatoryUser}
    employees={employees}
    creatorId={user.userId}
    client:load
  />
</Layout>
