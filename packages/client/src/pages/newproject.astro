---
import { db, Users, eq, or } from "astro:db";
import Layout from "../components/Layout.astro";
import { NewProject } from "../components/NewProject/NewProject";
import { Employee } from "../components/NewProject/NewProject";

const userId = Astro.locals.userId;
const data = (
  await db
    .select({ role: Users.role, name: Users.name })
    .from(Users)
    .where(eq(Users.userId, userId!))
)?.[0];
if (data?.role !== "admin" && data?.role !== "limited") return Astro.redirect("/401");
let mandatoryUser: Employee | undefined;
if (data!.role === "limited") {
  mandatoryUser = { value: userId!, label: data!.name };
}
const employees = await db
  .select({ value: Users.userId, label: Users.name })
  .from(Users)
  .where(or(eq(Users.role, "admin"), eq(Users.role, "limited")));
---

<Layout title={undefined} description={undefined}>
  <NewProject mandatoryMember={mandatoryUser} employees={employees} client:load />
</Layout>
