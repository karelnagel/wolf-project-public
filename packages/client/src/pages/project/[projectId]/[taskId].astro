---
import Layout from "../../../components/Layout.astro";
import { useTranslations } from "@wolf-project/i18n";
import { db, eq, like, Tasks, Users } from "astro:db";
// Todo where is this?
// import { AddComment } from "../../../components/Comment";
import { Comments } from "astro:db";

const t = useTranslations("en");

const { taskId } = Astro.params;
const id = taskId?.split("/")[0];
if (!id) throw new Error("id is required");

const task = await db.select().from(Tasks).where(like(Tasks.taskId, id));

const comments = await db
  .select({
    name: Users.name,
    job: Users.job,
    body: Comments.body,
    commentedAt: Comments.commentedAt,
  })
  .from(Comments)
  .where(like(Comments.taskRef, id))
  .innerJoin(Users, eq(Comments.commenterId, Users.userId));

// const userId =
//   "9f5b50e1-8aa2-432d-b6df-df78e9315c4e"; /*Placeholder for testing. Place any generated user id here*/
// const userId =
//   "9f5b50e1-8aa2-432d-b6df-df78e9315c4e"; /*Placeholder for testing. Place any generated user id here*/
---

<Layout title={undefined} description={undefined}>
  <a class="font-medium text-blue-600 underline dark:text-blue-500 hover:no-underline" href="/"
    >{t.project.title}</a
  >
  <p>Task subpage</p>
  {
    task.map(({ taskId, title, description, deadline, status }) => (
      <div>
        <p>Task ID: {taskId}</p>
        <p>Task title: {title}</p>
        <p>Task description: {description}</p>
        <p>
          Deadline:{" "}
          {deadline !== null
            ? `${deadline!.getDate()}.${deadline!.getMonth() + 1}.${deadline!.getFullYear()}`
            : null}
        </p>
        <p>Status: {status}</p>
      </div>
    ))
  }
  <div>
    {
      comments.map(({ body, name, job, commentedAt }) => (
        <div>
          <p>
            {name}
            {job !== null ? ` - ${job}` : null}
            {`${commentedAt!.getHours()}:${commentedAt.getMinutes()} ${commentedAt!.getDate()}.${commentedAt!.getMonth() + 1}.${commentedAt!.getFullYear()}`}
          </p>
          <p>{body} </p>
        </div>
      ))
    }
  </div>

  <!-- <AddComment taskRef={id} commenterId={userId} client:load /> -->
</Layout>
