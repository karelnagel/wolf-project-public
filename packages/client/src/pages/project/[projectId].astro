---
import Layout from "../../components/Layout.astro";
import { db } from "@wolf-project/db";
import { ProjectPage } from "../../components/ProjectPage";

const { projectId } = Astro.params;
if (!projectId) throw new Error("id is required");

const project = await db.query.projectsTable.findFirst({
  where: (x, { eq }) => eq(x.id, projectId),
  with: { tasks: true, users: { with: { user: true } } },
});
if (!project) throw new Error("project not found");
// Todo check if can edit
const canEdit = true;

const { form, status, type } = Astro.locals.t;
const t = { form, status, type };
const lang = Astro.locals.lang || "en";
---

<Layout title={undefined} description={undefined}>
  <ProjectPage
    t={t}
    canEdit={canEdit}
    project={{
      ...project,
      clients: project.users.filter((u) => u.priviledgeLevel === "client").map((u) => u.user),
      employees: project.users
        .filter((u) => u.priviledgeLevel !== "employee")
        .map((u) => u.userId),
      projectManager: project.users.find(u=>u.priviledgeLevel === "manager")?.userId,
    }}
    lang={lang}
    client:load
  />
</Layout>
